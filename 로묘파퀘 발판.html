<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로묘 발판</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f7fa;
        }
        .floor-number {
            width: 40px;
            text-align: right;
        }
        /* 중복 선택된 발판에 대한 스타일 */
        .platform.is-duplicate {
            border: 2px solid;
            border-color: #000; /* 검정색 테두리 */
            box-shadow: 0 0 0 2px #4b5563; /* 어두운 회색 그림자 */
        }
        /* 중복된 숫자가 있는 섹터에 대한 스타일 (플레이어 전체 칸) */
        .player-board.is-sector-duplicate {
            border: 2px solid;
            border-color: #ef4444; /* Tailwind's border-red-500 */
        }
        /* 추가된 디자인 요소 */
        .copy-button svg {
            fill: white;
            transition: transform 0.2s ease-in-out;
        }
        .copy-button:hover svg {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-6 min-h-screen">

    <div class="main-container flex flex-wrap justify-center gap-6">
    </div>

    <div class="mt-6 flex gap-4">
        <button id="reset-button" class="px-4 py-2 text-sm font-semibold text-white bg-red-500 rounded-lg shadow-md hover:bg-red-600 transition-colors">초기화</button>
        <button id="full-reset-button" class="px-4 py-2 text-sm font-semibold text-white bg-red-700 rounded-lg shadow-md hover:bg-red-800 transition-colors">전체 초기화</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mainContainer = document.querySelector('.main-container');
            const totalFloors = 10;
            const platformsPerFloor = 4;
            const totalPlayers = 4;
            
            // 각 플레이어의 발판 선택을 저장할 상태 배열 (내부 상태)
            const playerSelections = Array(totalPlayers).fill(null).map(() => Array(totalFloors).fill(null));

            function updatePlayerSelectionText(playerBoard) {
                const selectionTextElement = playerBoard.querySelector('.player-selection-text');
                const playerName = playerBoard.querySelector('.player-name-input').value;
                const playerIndex = playerBoard.getAttribute('data-player-id') - 1;
                
                const selectedPlatforms = playerSelections[playerIndex].filter(p => p !== null);
                
                let formattedText = '';
                for (let i = 0; i < selectedPlatforms.length; i++) {
                    formattedText += selectedPlatforms[i];
                    if ((i + 1) % 3 === 0 && i < selectedPlatforms.length - 1) {
                        formattedText += '/';
                    }
                }
                
                selectionTextElement.textContent = `${playerName} : ${formattedText}`;
            }

            function updateAllBoards() {
                // 중복된 숫자가 있는 플레이어 ID를 저장할 Set
                const playersWithDuplicates = new Set();
                
                for (let floor = 1; floor <= totalFloors; floor++) {
                    // 각 층의 발판 선택 횟수를 세기 위한 Map
                    const platformCounts = new Map();
                    for (let i = 0; i < totalPlayers; i++) {
                        const platformId = playerSelections[i][floor - 1];
                        if (platformId !== null) {
                            platformCounts.set(platformId, (platformCounts.get(platformId) || 0) + 1);
                        }
                    }

                    const floorsInAllBoards = document.querySelectorAll(`.floor[data-floor-id="${floor}"]`);

                    floorsInAllBoards.forEach(floorDiv => {
                        const playerBoard = floorDiv.closest('.player-board');
                        const playerIndex = playerBoard.getAttribute('data-player-id') - 1;
                        
                        floorDiv.querySelectorAll('.platform').forEach(platformDiv => {
                            const platformId = platformDiv.getAttribute('data-platform-id');
                            const isUsedByMe = playerSelections[playerIndex][floor - 1] === platformId;
                            const count = platformCounts.get(platformId) || 0;
                            
                            // 동적으로 추가된 클래스들을 모두 초기화합니다.
                            platformDiv.classList.remove('used-by-me', 'bg-red-500', 'hover:bg-red-600', 'bg-blue-400', 'hover:bg-blue-500', 'is-duplicate', 'bg-gray-400');
                            
                            // 내 발판이 선택됐을 경우
                            if (isUsedByMe) {
                                platformDiv.classList.add('used-by-me', 'bg-red-500', 'hover:bg-red-600');
                                if (count > 1) {
                                    playersWithDuplicates.add(playerIndex + 1);
                                }
                            } else {
                                // 다른 플레이어가 선택한 발판일 경우
                                if (count > 0) {
                                    platformDiv.classList.add('bg-gray-400');
                                } else {
                                    platformDiv.classList.add('bg-blue-400', 'hover:bg-blue-500');
                                }
                            }
                            
                            // 중복 선택일 경우 'is-duplicate' 클래스 추가
                            if (count > 1) {
                                platformDiv.classList.add('is-duplicate');
                            }
                        });
                    });

                    const allPlatformsUsed = platformCounts.size === platformsPerFloor;
                    
                    floorsInAllBoards.forEach(floorDiv => {
                        if (allPlatformsUsed) {
                            // 게임 성공 텍스트를 제거하고, 테두리만 녹색으로 변경합니다.
                            floorDiv.classList.add('border-green-500', 'ring-2', 'ring-green-500');
                            floorDiv.classList.remove('bg-green-100');
                        } else {
                            floorDiv.classList.remove('border-green-500', 'ring-2', 'ring-green-500', 'bg-green-100');
                        }
                    });
                }
                
                // 중복된 숫자가 있는 플레이어 칸에 테두리 적용
                document.querySelectorAll('.player-board').forEach(playerBoard => {
                    const playerId = parseInt(playerBoard.getAttribute('data-player-id'));
                    if (playersWithDuplicates.has(playerId)) {
                        playerBoard.classList.add('is-sector-duplicate');
                    } else {
                        playerBoard.classList.remove('is-sector-duplicate');
                    }
                });
            }

            // 숫자 입력란의 값을 기준으로 보드를 업데이트하는 함수 (우선순위)
            function selectPlatformsByInput(inputElement) {
                const playerBoard = inputElement.closest('.player-board');
                const playerIndex = playerBoard.getAttribute('data-player-id') - 1;
                const floorInputs = inputElement.value.split('');
                
                // 내부 상태 배열 초기화
                for (let i = 0; i < totalFloors; i++) {
                    playerSelections[playerIndex][i] = null;
                }
                
                floorInputs.forEach((platformNumber, index) => {
                    const floorId = index + 1;
                    const platformId = platformNumber;
                    
                    if (floorId <= totalFloors && platformId >= 1 && platformId <= platformsPerFloor) {
                        playerSelections[playerIndex][floorId - 1] = platformId;
                    }
                });

                updateAllBoards();
                updatePlayerSelectionText(playerBoard);
            }

            function resetSelections() {
                // 내부 상태 배열 초기화
                for (let i = 0; i < totalPlayers; i++) {
                    for (let j = 0; j < totalFloors; j++) {
                        playerSelections[i][j] = null;
                    }
                }

                document.querySelectorAll('.platform').forEach(p => {
                    p.classList.remove('used-by-me', 'used-by-other', 'bg-red-500', 'hover:bg-red-600', 'is-duplicate', 'bg-gray-400');
                    p.classList.add('bg-blue-400', 'hover:bg-blue-500');
                });
                document.querySelectorAll('.player-board').forEach(f => {
                    f.classList.remove('is-sector-duplicate');
                });
                document.querySelectorAll('.player-floor-input').forEach(input => {
                    input.value = '';
                });
                document.querySelectorAll('.player-selection-text').forEach(textDiv => {
                    const playerName = textDiv.closest('.player-board').querySelector('.player-name-input').value;
                    textDiv.textContent = `${playerName} : `;
                });
                document.querySelectorAll('.floor').forEach(floor => {
                    floor.classList.remove('border-green-500', 'ring-2', 'ring-green-500', 'bg-green-100');
                });
            }

            function fullReset() {
                resetSelections();
                document.querySelectorAll('.player-name-input').forEach(input => {
                    input.value = '';
                });
                document.querySelectorAll('.player-selection-text').forEach(textDiv => {
                    textDiv.textContent = '이름 : ';
                });
            }

            document.getElementById('reset-button').addEventListener('click', resetSelections);
            document.getElementById('full-reset-button').addEventListener('click', fullReset);

            for (let player = 1; player <= totalPlayers; player++) {
                const playerBoard = document.createElement('div');
                playerBoard.classList.add('player-board', 'flex', 'flex-col', 'items-center', 'p-4', 'bg-white', 'rounded-xl', 'shadow-lg', 'border', 'border-gray-200');
                playerBoard.setAttribute('data-player-id', player);

                const playerNameInput = document.createElement('input');
                playerNameInput.setAttribute('type', 'text');
                playerNameInput.setAttribute('placeholder', '이름 입력');
                playerNameInput.classList.add('player-name-input', 'w-36', 'mb-3', 'p-1', 'text-sm', 'text-center', 'border-b-2', 'border-gray-300', 'focus:outline-none', 'focus:border-blue-500', 'transition-colors');
                
                const playerFloorInput = document.createElement('input');
                playerFloorInput.setAttribute('type', 'text');
                playerFloorInput.setAttribute('placeholder', '숫자입력');
                playerFloorInput.setAttribute('maxlength', '10');
                playerFloorInput.classList.add('player-floor-input', 'w-48', 'mb-4', 'p-1', 'text-sm', 'text-center', 'border', 'border-gray-300', 'rounded-md', 'focus:outline-none', 'focus:border-blue-500', 'transition-colors');
                
                playerNameInput.addEventListener('input', () => {
                    updatePlayerSelectionText(playerBoard);
                });
                // 숫자 입력란 변경 시 selectPlatformsByInput 함수를 호출
                playerFloorInput.addEventListener('input', () => selectPlatformsByInput(playerFloorInput));

                const floorContainer = document.createElement('div');
                floorContainer.classList.add('floor-container', 'flex', 'flex-col-reverse', 'gap-1');

                for (let floor = 1; floor <= totalFloors; floor++) {
                    const floorDiv = document.createElement('div');
                    floorDiv.classList.add('floor', 'relative', 'flex', 'items-center', 'p-2', 'bg-gray-50', 'rounded-lg', 'border', 'border-gray-200', 'shadow-sm', 'w-72', 'transition-all', 'duration-300');
                    floorDiv.setAttribute('data-floor-id', floor);
                    
                    if (floor === 3 || floor === 6 || floor === 9) {
                        floorDiv.classList.add('mt-2');
                    }
                    
                    const floorNumberDiv = document.createElement('div');
                    floorNumberDiv.classList.add('floor-number', 'font-bold', 'text-sm', 'text-gray-700', 'mr-2');
                    floorNumberDiv.textContent = `${floor}층`;

                    const platformRowDiv = document.createElement('div');
                    platformRowDiv.classList.add('platform-row', 'flex', 'gap-2');

                    for (let platform = 1; platform <= platformsPerFloor; platform++) {
                        const platformDiv = document.createElement('div');
                        platformDiv.classList.add('platform', 'w-12', 'h-12', 'bg-blue-400', 'text-white', 'font-semibold', 'rounded-lg', 'flex', 'items-center', 'justify-center', 'cursor-pointer', 'select-none', 'transition-colors', 'duration-200', 'shadow-md', 'hover:bg-blue-500');
                        platformDiv.textContent = platform;
                        platformDiv.setAttribute('data-platform-id', platform);

                        // 클릭 시 입력란의 값을 수정하고, 바로 보드를 업데이트
                        platformDiv.addEventListener('click', (event) => {
                            const currentPlatform = event.target;
                            const floorId = parseInt(currentPlatform.closest('.floor').getAttribute('data-floor-id'));
                            const platformId = currentPlatform.getAttribute('data-platform-id');
                            const playerBoard = currentPlatform.closest('.player-board');
                            const playerIndex = playerBoard.getAttribute('data-player-id') - 1;
                            
                            const currentSelection = playerSelections[playerIndex][floorId - 1];

                            if (currentSelection === platformId) {
                                // 선택 해제
                                playerSelections[playerIndex][floorId - 1] = null;
                            } else {
                                // 새로운 발판 선택
                                playerSelections[playerIndex][floorId - 1] = platformId;
                            }
                            
                            // 입력 필드 값 업데이트 (공백 제거)
                            const playerFloorInput = playerBoard.querySelector('.player-floor-input');
                            const formattedValue = playerSelections[playerIndex].filter(p => p !== null).join('');
                            playerFloorInput.value = formattedValue;
                            
                            updateAllBoards();
                            updatePlayerSelectionText(playerBoard);
                        });
                        platformRowDiv.appendChild(platformDiv);
                    }
                    floorDiv.appendChild(floorNumberDiv);
                    floorDiv.appendChild(platformRowDiv);
                    floorContainer.appendChild(floorDiv);
                }
                playerBoard.appendChild(playerNameInput);
                playerBoard.appendChild(playerFloorInput);
                playerBoard.appendChild(floorContainer);

                const bottomContainer = document.createElement('div');
                bottomContainer.classList.add('flex', 'items-center', 'justify-between', 'w-full', 'mt-4');

                const playerSelectionText = document.createElement('div');
                playerSelectionText.classList.add('player-selection-text', 'p-3', 'text-sm', 'font-semibold', 'text-gray-700', 'text-center', 'bg-gray-100', 'rounded-lg', 'border', 'border-dashed', 'border-gray-300', 'w-full', 'break-words', 'mr-2');
                playerSelectionText.textContent = '이름 : ';
                bottomContainer.appendChild(playerSelectionText);
                
                const copyButton = document.createElement('button');
                copyButton.setAttribute('title', '복사하기');
                copyButton.classList.add('copy-button', 'shrink-0', 'w-8', 'h-8', 'flex', 'items-center', 'justify-center', 'bg-green-500', 'rounded-md', 'shadow-md', 'hover:bg-green-600', 'transition-colors');
                copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
                    <path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM15 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H15C16.1 23 17 22.1 17 21V7C17 5.9 16.1 5 15 5ZM15 21H8V7H15V21Z" />
                </svg>`;

                copyButton.addEventListener('click', () => {
                    const isFirstPlayer = playerBoard.getAttribute('data-player-id') === '1';
                    const textToCopy = isFirstPlayer ? playerSelectionText.textContent.split(': ')[1].trim() : playerSelectionText.textContent.trim();
                    
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(textToCopy).then(() => {
                            // Optionally, add a visual feedback
                        }).catch(err => {
                            console.error('복사 실패:', err);
                        });
                    } else {
                        const tempInput = document.createElement('textarea');
                        tempInput.value = textToCopy;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                    }
                });
                bottomContainer.appendChild(copyButton);

                playerBoard.appendChild(bottomContainer);
                mainContainer.appendChild(playerBoard);
            }
        });
    </script>
</body>
</html>
